name: CI

on:
  push:
    branches: [ main, 'task-*' ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 jupyter nbconvert dvc

    - name: Try DVC pull (non-fatal)
      run: |
        if command -v dvc >/dev/null 2>&1; then
          dvc pull || echo "dvc pull failed or remote not configured; continuing"
        else
          echo "dvc not installed"
        fi

    - name: Lint with flake8
      run: |
        # run flake8 on repository if there are python files (ignore failures only for now)
        python_files=$(git ls-files '*.py' | wc -l)
        if [ "$python_files" -gt 0 ]; then
          flake8 || true
        else
          echo 'No python files to lint.'
        fi

    - name: Execute notebooks (smoke test)
      run: |
        # Execute notebooks if present; allow cells to error without failing workflow
        if [ -f notebooks/01_EDA_Statistical_Thinking.ipynb ]; then
          jupyter nbconvert --to notebook --execute notebooks/01_EDA_Statistical_Thinking.ipynb --ExecutePreprocessor.timeout=600 --ExecutePreprocessor.allow_errors=True --output tmp_01.ipynb || echo 'Notebook 01 execution finished (errors allowed)'
        else
          echo 'Notebook 01 missing'
        fi
        if [ -f notebooks/02_AB_Hypothesis_Testing.ipynb ]; then
          jupyter nbconvert --to notebook --execute notebooks/02_AB_Hypothesis_Testing.ipynb --ExecutePreprocessor.timeout=600 --ExecutePreprocessor.allow_errors=True --output tmp_02.ipynb || echo 'Notebook 02 execution finished (errors allowed)'
        else
          echo 'Notebook 02 missing'
        fi

    - name: Run tests (if present)
      run: |
        if [ -f pytest.ini ] || [ -d tests ]; then
          pytest -q || true
        else
          echo 'No tests detected; skipping pytest.'
        fi